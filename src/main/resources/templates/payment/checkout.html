<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Checkout - HappyGhumakkads</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet"/>
</head>
<body class="d-flex flex-column min-vh-100">
<div th:replace="fragments/header :: siteHeader"></div>

<section class="py-5">
  <div class="container">
    <div class="card shadow-sm">
      <div class="card-body">
        <h1 class="h4 mb-3">Checkout</h1>
        <div class="mb-3">Booking <strong th:text="${booking.bookingReference}">REF</strong> â€” Amount â‚¹<strong th:text="${#numbers.formatInteger(booking.totalAmount, 0)}">0</strong></div>
        <button id="rzp-button" class="btn btn-success"><i class="fa fa-indian-rupee-sign me-2"></i>Pay with Razorpay</button>
        <div th:if="${error}" class="alert alert-danger mt-3" th:text="${error}"></div>
      </div>
    </div>
  </div>
  </section>

<div class="mt-auto" th:replace="fragments/footer :: siteFooter"></div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script th:inline="javascript">
  /*<![CDATA[*/
  const RZP_KEY = /*[[${keyId}]]*/ 'rzp_key_placeholder';
  const AMOUNT_PAISE = /*[[${amountPaise}]]*/ 100;
  const ORDER_ID = /*[[${orderId}]]*/ '';
  const PREFILL_NAME = /*[[${booking.user.fullName}]]*/ '';
  const PREFILL_EMAIL = /*[[${booking.user.email}]]*/ '';
  const PREFILL_CONTACT = /*[[${booking.user.phoneNumber}]]*/ '';

  console.log('Razorpay Configuration:');
  console.log('- Key ID:', RZP_KEY);
  console.log('- Amount (paise):', AMOUNT_PAISE);
  console.log('- Order ID:', ORDER_ID);
  console.log('- Customer:', PREFILL_NAME, PREFILL_EMAIL);

  // Validate that all required data is present
  if (!ORDER_ID || ORDER_ID === '' || ORDER_ID === 'null') {
    console.error('ERROR: Order ID is missing or invalid');
    alert('Payment initialization failed: Missing order ID. Please try again.');
    window.location.href = '/packages';
  }
  
  if (!RZP_KEY || RZP_KEY === 'rzp_key_placeholder') {
    console.error('ERROR: Razorpay Key ID is not configured');
    alert('Payment gateway not configured. Please contact support.');
  }

  const options = {
    key: RZP_KEY,
    amount: AMOUNT_PAISE,
    currency: 'INR',
    name: 'HappyGhumakkads',
    description: 'Travel Booking Payment',
    order_id: ORDER_ID,
    prefill: {
      name: PREFILL_NAME,
      email: PREFILL_EMAIL,
      contact: PREFILL_CONTACT
    },
    theme: { color: '#0d6efd' },
    handler: function (response){
      // Payment successful - submit to server
      console.log('âœ… Payment successful:', response);
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/payment/success';
      
      // Add payment response data
      for (const [k,v] of Object.entries(response)){
        const input = document.createElement('input');
        input.type='hidden'; 
        input.name=k; 
        input.value=v; 
        form.appendChild(input);
        console.log('Adding field:', k, '=', v);
      }
      document.body.appendChild(form);
      console.log('Submitting payment success form...');
      form.submit();
    },
    modal: { 
      ondismiss: function(){
        // User closed the payment modal
        console.log('âš ï¸ Payment cancelled by user');
        const form = document.createElement('form');
        form.method='POST'; 
        form.action='/payment/failed';
        
        const o=document.createElement('input'); 
        o.type='hidden'; 
        o.name='razorpay_order_id'; 
        o.value=ORDER_ID; 
        form.appendChild(o);
        
        const errorInput = document.createElement('input');
        errorInput.type='hidden';
        errorInput.name='error';
        errorInput.value='Payment cancelled by user';
        form.appendChild(errorInput);
        
        document.body.appendChild(form);
        form.submit();
      },
      escape: true,
      backdropclose: false
    }
  };
  
  const rzp1 = new Razorpay(options);
  
  // Add error event listener
  rzp1.on('payment.failed', function (response){
    console.error('âŒ Payment failed:', response.error);
    console.error('Error details:', {
      code: response.error.code,
      description: response.error.description,
      source: response.error.source,
      step: response.error.step,
      reason: response.error.reason,
      metadata: response.error.metadata
    });
    
    alert('Payment failed: ' + response.error.description);
    const form = document.createElement('form');
    form.method='POST'; 
    form.action='/payment/failed';
    
    const o=document.createElement('input'); 
    o.type='hidden'; 
    o.name='razorpay_order_id'; 
    o.value=ORDER_ID; 
    form.appendChild(o);
    
    const errorInput = document.createElement('input');
    errorInput.type='hidden';
    errorInput.name='error';
    errorInput.value=response.error.description || 'Payment failed';
    form.appendChild(errorInput);
    
    const codeInput = document.createElement('input');
    codeInput.type='hidden';
    codeInput.name='error_code';
    codeInput.value=response.error.code || '';
    form.appendChild(codeInput);
    
    document.body.appendChild(form);
    form.submit();
  });
  
  // Attach button click handler
  const rzpButton = document.getElementById('rzp-button');
  if (!rzpButton) {
    console.error('ERROR: Razorpay button not found in DOM');
  } else {
    console.log('âœ… Razorpay button found, attaching click handler');
    rzpButton.onclick = function(e){
      e.preventDefault();
      console.log('ðŸ”µ Pay with Razorpay button clicked');
      console.log('Opening Razorpay checkout modal...');
      try {
        rzp1.open();
        console.log('âœ… Razorpay checkout modal opened successfully');
      } catch (error) {
        console.error('âŒ Error opening Razorpay:', error);
        alert('Failed to open payment gateway: ' + error.message + '. Please check console for details.');
      }
    };
  }
  
  console.log('âœ… Razorpay integration initialized successfully');
  /*]]>*/
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
